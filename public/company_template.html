<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- タイトルはWorker側で置換される -->
  <title>ようこそ __COMPANY_NAME__ 様</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" /> <!-- Font Awesome -->
  <!-- 必要に応じて /styles/main.css も参照 -->
  <link href="/styles/main.css" rel="stylesheet">
  <style>
    body { background-color: #f9fafb; padding: 2rem; }
    .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { font-size: 1.875rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937; }
    h2 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; }
    p { color: #4b5563; line-height: 1.6; }
    hr { border-top: 1px solid #e5e7eb; margin-top: 1rem; margin-bottom: 1rem; }
    .radio-group { display: flex; gap: 1rem; }
    .radio-option { display: flex; align-items: center; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; }
    .btn-primary { background-color: #4f46e5; color: white; }
    .btn-primary:hover { background-color: #4338ca; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
    input[type="text"], input[type="date"], input[type="email"], input[type="tel"] {
        width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 4px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
    .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 1rem; }
    .success-message { color: #10b981; font-size: 0.875rem; margin-top: 1rem; }
    #loading-overlay { transition: opacity 0.3s ease-in-out; }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    /* ポップアップメッセージ用スタイル */
    #toast-container {
      position: fixed;
      top: 1.25rem; /* 20px */
      right: 1.25rem; /* 20px */
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 0.5rem; /* 8px */
    }
    .toast {
      padding: 1rem; /* 16px */
      border-radius: 0.375rem; /* 6px */
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .toast.success {
      background-color: #10b981; /* green-500 */
    }
    .toast.error {
      background-color: #ef4444; /* red-500 */
    }
    .toast.fade-out {
        opacity: 0;
    }
    /* テーブルのスタイル調整 (任意) */
    th, td { text-align: left; }
    th.action-col, td.action-col { text-align: center; width: 5%; }

    .tab-content.hidden {
        display: none;
    }
  </style>
</head>
<body>
  <div id="loading-overlay" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
    <p class="text-white text-xl">分析中です...</p>
  </div>

  <div id="toast-container"></div>

  <!-- ★★★ ここから追加: 初期確認モーダル ★★★ -->
  <div id="initial-delete-confirm-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md mx-auto">
          <h3 class="text-xl font-medium mb-4 text-gray-900">実行内容の確認</h3>
          <p id="initial-delete-message" class="text-base text-gray-600 mb-4">（ここに削除件数を表示）</p>
          <div class="flex justify-end gap-2">
              <button type="button" id="cancel-initial-delete-button" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800">キャンセル</button>
              <button type="button" id="confirm-initial-delete-button" class="btn bg-red-600 hover:bg-red-700 text-white">OK</button>
          </div>
      </div>
  </div>
  <!-- ★★★ ここまで追加 ★★★ -->

  <!-- ★ 削除最終確認用モーダル -->
  <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md mx-auto">
          <h3 class="text-xl font-medium mb-4 text-gray-900">最終確認</h3>
          <p class="text-base text-gray-600 mb-4">本当に選択した結果を削除しますか？<br>この操作は元に戻せません。</p>
          <label for="delete-confirm-input" class="block text-base font-medium text-gray-700 mb-1">確認のため、「削除」と入力してください:</label>
          <input type="text" id="delete-confirm-input" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md mb-4">
          <div class="flex justify-end gap-2">
              <button type="button" id="cancel-delete-button" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800">キャンセル</button>
              <button type="button" id="final-delete-button" class="btn bg-red-600 hover:bg-red-700 text-white" disabled>削除実行</button>
          </div>
      </div>
  </div>

  <div class="container">
    <!-- ★★★ ここからヘッダーとタブUIの統合・修正 ★★★ -->
    <div class="header-section mb-6 bg-white sticky top-0 z-40 py-3 px-4 rounded-t-lg shadow-sm border-b border-gray-200 -mx-8 -mt-8 mb-6">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-xl sm:text-2xl font-bold mb-1 text-gray-800">__COMPANY_NAME__ 様 専用ページ</h1>
        <div class="text-xs sm:text-sm text-gray-600 mb-3 flex space-x-4">
          <span>担当者: __CONTACT_PERSON__</span>
          <span>登録日: __CREATED_AT__</span>
        </div>
        <!-- タブナビゲーション -->
        <nav class="flex space-x-4 border-t pt-2" aria-label="Tabs">
          <button id="form-tab" class="tab-button active px-3 py-2 font-medium text-sm rounded-md text-blue-600 border-b-2 border-blue-500">
            <i class="fas fa-edit mr-1"></i>分析フォーム
          </button>
          <button id="results-tab" class="tab-button px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-blue-600 hover:border-b-2 hover:border-blue-300">
            <i class="fas fa-list mr-1"></i>分析結果一覧
          </button>
        </nav>
      </div>
    </div>
    <!-- ★★★ ここまでヘッダーとタブUI ★★★ -->

    <!-- 分析フォーム タブコンテンツ -->
    <div id="form-content" class="tab-content active">
      <form onsubmit="submitForm(event)" class="max-w-lg mx-auto pt-4">
        <input type="hidden" name="pageId" value="__PAGE_ID__">
        <div class="mb-4 flex gap-4">
          <div class="w-1/2">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="familyName"> 姓（漢字） </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="familyName" name="familyName" type="text" required value="山田" />
          </div>
          <div class="w-1/2">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="firstName"> 名（漢字） </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="firstName" name="firstName" type="text" required value="太郎" />
          </div>
        </div>
        <div class="mb-4 flex gap-4">
          <div class="w-1/2">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="familyNameKana"> 姓（ふりがな） </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="familyNameKana" name="familyNameKana" type="text" required value="やまだ" />
          </div>
          <div class="w-1/2">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="firstNameKana"> 名（ふりがな） </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="firstNameKana" name="firstNameKana" type="text" required value="たろう" />
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2" for="birthdate"> 生年月日 </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="birthdate" name="birthdate" type="date" required value="1992-02-14" />
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 text-sm font-bold mb-2"> 性別 </label>
          <div class="radio-group">
            <label class="radio-option"> <input type="radio" name="gender" value="male" required checked /> <span>男性</span> </label>
            <label class="radio-option"> <input type="radio" name="gender" value="female" /> <span>女性</span> </label>
          </div>
        </div>
        <div class="text-center mt-6">
          <button class="btn btn-primary" type="submit"> 診断する </button>
        </div>
      </form>
    </div>

    <!-- 分析結果一覧 タブコンテンツ -->
    <div id="results-content" class="tab-content hidden">
      <form id="deleteResultsForm" class="pt-4">
        <div id="resultsList">
          <p>（ここに分析結果の一覧が表示されます）</p>
        </div>
        <div class="text-right mt-4">
          <button type="button" id="deleteButton" class="btn bg-red-600 hover:bg-red-700 text-white" disabled>選択した結果を削除</button>
        </div>
      </form>
    </div>

  </div>

  <script>
    /* ポップアップ表示関数 */
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      /* 5秒後にフェードアウトして削除 */
      setTimeout(() => {
          toast.classList.add('fade-out');
          /* アニメーション完了後に要素を削除 */
          setTimeout(() => {
              toast.remove();
          }, 500); /* transitionの時間と合わせる */
      }, 5000);
    }

    async function submitForm(event) {
      event.preventDefault();
      const submitButton = document.querySelector('button[type="submit"]');
      const loadingOverlay = document.getElementById('loading-overlay');

      loadingOverlay.classList.remove('hidden');
      submitButton.disabled = true;

      try {
        const formData = new FormData(event.target);
        const response = await fetch('/api/results', {
          method: 'POST',
          body: JSON.stringify(Object.fromEntries(formData)),
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const result = await response.json();

        if (response.ok) {
          /* 成功時はポップアップ表示せず、ハッシュを設定してリロード */
          const resultId = result.id || '不明';
          location.hash = `#analysis-success=${resultId}`; /* ハッシュ設定 */
          location.reload(); /* リロード実行 */
        } else {
          /* エラー時はポップアップ表示 (リロードしない) */
          showToast('分析に失敗しました: ' + (result.error || `サーバーエラー(${response.status})`), 'error');
          submitButton.disabled = false; /* エラー時はボタンを再度有効化 */
        }
      } catch (error) {
        console.error('Analysis submission error:', error);
        /* 通信エラー時もポップアップ表示 (リロードしない) */
        showToast('通信エラーが発生しました。', 'error');
        submitButton.disabled = false; /* エラー時はボタンを再度有効化 */
      } finally {
        /* ローディング解除はエラー時のみ必要 */
        /* If an error occurred, the submit button should be re-enabled here instead of in the catch blocks */
        /* as the finally block executes regardless of whether an error occurred. */
        if (!location.hash.startsWith('#analysis-success=')) { /* Only hide overlay and re-enable button if not reloading */
             loadingOverlay.classList.add('hidden');
             /* We already re-enable the button in the error cases above, no need to do it again here. */
             /* submitButton.disabled = false; */
         } /* If success, reload handles overlay hiding. */
      }
    }

    /* ★ ページ読み込み完了時の処理を追加 */
    document.addEventListener('DOMContentLoaded', () => {
        if (location.hash.startsWith('#analysis-success=')) {
            const resultId = location.hash.split('=')[1];
            showToast('分析が完了しました。結果ID: ' + resultId, 'success');
            /* URLからハッシュを削除してクリーンな状態に戻す */
            history.replaceState(null, null, ' '); /* More robust way to clear hash without triggering navigation */
            /* location.hash = ''; // simpler alternative */
        }
    });

    const deleteForm = document.getElementById('deleteResultsForm');
    const deleteButton = document.getElementById('deleteButton');
    const resultsList = document.getElementById('resultsList');
    const initialDeleteConfirmModal = document.getElementById('initial-delete-confirm-modal');
    const initialDeleteMessage = document.getElementById('initial-delete-message');
    const cancelInitialDeleteButton = document.getElementById('cancel-initial-delete-button');
    const confirmInitialDeleteButton = document.getElementById('confirm-initial-delete-button');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteButton = document.getElementById('cancel-delete-button');
    const finalDeleteButton = document.getElementById('final-delete-button');
    const deleteConfirmInput = document.getElementById('delete-confirm-input');
    let idsToDelete = [];

    // ★ チェックボックス変更時に削除ボタンを有効/無効化
    resultsList.addEventListener('change', (event) => {
        if (event.target.classList.contains('delete-checkbox')) {
            const checkedBoxes = resultsList.querySelectorAll('input.delete-checkbox:checked');
            deleteButton.disabled = checkedBoxes.length === 0;
        }
    });

    // ★ 「選択した結果を削除」ボタンクリック
    deleteButton.addEventListener('click', () => {
        const checkedBoxes = resultsList.querySelectorAll('input.delete-checkbox:checked');
        idsToDelete = Array.from(checkedBoxes).map(cb => cb.value);

        if (idsToDelete.length === 0) {
            showToast('削除する結果を選択してください。', 'error');
            return;
        }

        initialDeleteMessage.textContent = `${idsToDelete.length}件の結果を削除します。よろしいですか？`;
        initialDeleteConfirmModal.classList.remove('hidden');
    });

    // ★ 初期確認モーダル：キャンセルボタン
    cancelInitialDeleteButton.addEventListener('click', () => {
        initialDeleteConfirmModal.classList.add('hidden');
        idsToDelete = [];
    });

    // ★ 初期確認モーダル：OKボタン
    confirmInitialDeleteButton.addEventListener('click', () => {
        initialDeleteConfirmModal.classList.add('hidden');
        deleteConfirmInput.value = '';
        finalDeleteButton.disabled = true;
        deleteConfirmModal.classList.remove('hidden');
    });

    // 最終確認モーダル：キャンセルボタン
    cancelDeleteButton.addEventListener('click', () => {
        deleteConfirmModal.classList.add('hidden');
        idsToDelete = [];
    });

    // 最終確認モーダル：入力チェック
    deleteConfirmInput.addEventListener('input', () => {
        finalDeleteButton.disabled = deleteConfirmInput.value !== '削除';
    });

    // 最終確認モーダル：削除実行ボタン
    finalDeleteButton.addEventListener('click', async () => {
        if (deleteConfirmInput.value !== '削除' || idsToDelete.length === 0) {
            return;
        }

        finalDeleteButton.disabled = true;
        finalDeleteButton.textContent = '削除中...';

        try {
            const currentPageId = document.querySelector('input[name="pageId"]').value;
            const response = await fetch('/api/results/delete', { // ★ エンドポイント注意
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pageId: currentPageId,
                    resultIds: idsToDelete
                }),
            });

            const result = await response.json();

            if (response.ok) {
                showToast(result.message || '削除しました。', 'success');
                setTimeout(() => { location.reload(); }, 1000);
            } else {
                showToast(result.error || '削除に失敗しました。', 'error');
                finalDeleteButton.disabled = false;
                finalDeleteButton.textContent = '削除実行';
            }
        } catch (error) {
            console.error('Delete error:', error);
            showToast('削除中にエラーが発生しました。', 'error');
            finalDeleteButton.disabled = false;
            finalDeleteButton.textContent = '削除実行';
        } finally {
            deleteConfirmModal.classList.add('hidden');
        }
    });

  </script>

  <!-- ★★★ ここに追加: タブ切り替え用スクリプト ★★★ -->
  <script type="module" src="/scripts/company-tabs.js"></script>
  <!-- ★★★ ここまで追加 ★★★ -->

</body>
</html>
